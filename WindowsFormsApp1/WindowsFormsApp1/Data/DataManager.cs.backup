using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Security.Cryptography;
using System.Text;
using System.Linq;
using System.Data;

namespace WindowsFormsApp1.Data
{
    public class DataManager
    {
        private static DataManager instance;

        // Mặc định là 0 (Chưa đăng nhập/Guest)
        private int currentUserId = 0;

        public static DataManager Instance
        {
            get
            {
                if (instance == null) instance = new DataManager();
                return instance;
            }
        }

        private DataManager() { }

        // --- QUẢN LÝ USER ID ---
        public void SetCurrentUser(int userId)
        {
            currentUserId = userId;
        }

        public int GetCurrentUser()
        {
            return currentUserId;
        }

        // --- LOGIC ĐĂNG NHẬP / ĐĂNG KÝ ---
        private string HashPassword(string password)
        {
            using (SHA256 sha256 = SHA256.Create())
            {
                byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
                StringBuilder builder = new StringBuilder();
                for (int i = 0; i < bytes.Length; i++)
                {
                    builder.Append(bytes[i].ToString("x2"));
                }
                return builder.ToString();
            }
        }

        public User Login(string username, string password)
        {
            string hashedPassword = HashPassword(password);
            string query = "SELECT MaNguoiDung, TenDangNhap, TenHienThi, Email FROM NguoiDung WHERE (TenDangNhap = @User OR Email = @User) AND MatKhauHash = @Pass";

            try
            {
                using (var conn = DatabaseConnection.Instance.GetConnection())
                {
                    conn.Open();
                    using (var cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@User", username);
                        cmd.Parameters.AddWithValue("@Pass", hashedPassword);

                        using (var reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                var user = new User
                                {
                                    Id = reader.GetInt32(0),
                                    Username = reader.GetString(1),
                                    DisplayName = reader.IsDBNull(2) ? reader.GetString(1) : reader.GetString(2),
                                    Email = reader.IsDBNull(3) ? "" : reader.GetString(3)
                                };

                                SetCurrentUser(user.Id);
                                return user;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show("Lỗi đăng nhập: " + ex.Message);
            }
            return null;
        }

        public User Register(string username, string password, string displayName, string email)
        {
            if (IsUserExists(username))
            {
                throw new Exception("Tên đăng nhập đã tồn tại!");
            }

            string hashedPassword = HashPassword(password);
            string query = @"
                INSERT INTO NguoiDung (TenDangNhap, MatKhauHash, TenHienThi, Email, NgayTao)
                VALUES (@User, @Pass, @Name, @Email, GETDATE());
                SELECT CAST(SCOPE_IDENTITY() as int);";

            try
            {
                using (var conn = DatabaseConnection.Instance.GetConnection())
                {
                    conn.Open();
                    using (var cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@User", username);
                        cmd.Parameters.AddWithValue("@Pass", hashedPassword);
                        cmd.Parameters.AddWithValue("@Name", displayName);
                        cmd.Parameters.AddWithValue("@Email", email ?? "");

                        int newId = (int)cmd.ExecuteScalar();
                        SetCurrentUser(newId);

                        return new User
                        {
                            Id = newId,
                            Username = username,
                            DisplayName = displayName,
                            Email = email
                        };
                    }
                }
            }
            catch (Exception ex)
            {
                throw new Exception("Lỗi đăng ký: " + ex.Message);
            }
        }

        public bool IsUserExists(string username)
        {
            string query = "SELECT COUNT(1) FROM NguoiDung WHERE TenDangNhap = @User";
            using (var conn = DatabaseConnection.Instance.GetConnection())
            {
                conn.Open();
                using (var cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@User", username);
                    return (int)cmd.ExecuteScalar() > 0;
                }
            }
        }

        // --- CÁC HÀM QUẢN LÝ SÁCH ---

        public List<Book> GetAllBooks()
        {
            string query = @"
                SELECT s.*, STRING_AGG(tg.TenTacGia, ', ') AS DanhSachTacGia
                FROM Sach s
                LEFT JOIN Sach_TacGia stg ON s.MaSach = stg.MaSach
                LEFT JOIN TacGia tg ON stg.MaTacGia = tg.MaTacGia
                WHERE s.MaNguoiDung = @Uid 
                AND s.MaSach NOT IN (SELECT MaSach FROM ThungRac)
                GROUP BY s.MaSach, s.MaNguoiDung, s.MaNhaXuatBan, s.TieuDe, s.MoTa, 
                         s.MaMD5, s.DuongDanAnhBia, s.DinhDang, s.KichThuocKB, 
                         s.TongSoTrang, s.DuongDanFile, s.NgayThem, s.TrangHienTai, 
                         s.XepHang, s.YeuThich
                ORDER BY s.NgayThem DESC";

            return ExecuteBookQuery(query);
        }

        public List<Book> GetDeletedBooks()
        {
            string query = @"
                SELECT s.*, STRING_AGG(tg.TenTacGia, ', ') AS DanhSachTacGia
                FROM Sach s
                INNER JOIN ThungRac tr ON s.MaSach = tr.MaSach
                LEFT JOIN Sach_TacGia stg ON s.MaSach = stg.MaSach
                LEFT JOIN TacGia tg ON stg.MaTacGia = tg.MaTacGia
                WHERE s.MaNguoiDung = @Uid
                GROUP BY s.MaSach, s.MaNguoiDung, s.MaNhaXuatBan, s.TieuDe, s.MoTa, 
                         s.MaMD5, s.DuongDanAnhBia, s.DinhDang, s.KichThuocKB, 
                         s.TongSoTrang, s.DuongDanFile, s.NgayThem, s.TrangHienTai, 
                         s.XepHang, s.YeuThich";

            var books = ExecuteBookQuery(query);
            books.ForEach(b => b.IsDeleted = true);
            return books;
        }

        public List<Book> GetFavoriteBooks()
        {
            string query = @"
                SELECT s.*, STRING_AGG(tg.TenTacGia, ', ') AS DanhSachTacGia
                FROM Sach s
                LEFT JOIN Sach_TacGia stg ON s.MaSach = stg.MaSach
                LEFT JOIN TacGia tg ON stg.MaTacGia = tg.MaTacGia
                WHERE s.MaNguoiDung = @Uid AND s.YeuThich = 1
                AND s.MaSach NOT IN (SELECT MaSach FROM ThungRac)
                GROUP BY s.MaSach, s.MaNguoiDung, s.MaNhaXuatBan, s.TieuDe, s.MoTa, s.MaMD5, s.DuongDanAnhBia, s.DinhDang, s.KichThuocKB, s.TongSoTrang, s.DuongDanFile, s.NgayThem, s.TrangHienTai, s.XepHang, s.YeuThich";

            return ExecuteBookQuery(query);
        }

        private List<Book> ExecuteBookQuery(string query)
        {
            var list = new List<Book>();
            try
            {
                using (var conn = DatabaseConnection.Instance.GetConnection())
                {
                    conn.Open();
                    using (var cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@Uid", currentUserId);
                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                var book = new Book
                                {
                                    Id = Convert.ToInt32(reader["MaSach"]),
                                    Title = reader["TieuDe"].ToString(),
                                    Author = reader["DanhSachTacGia"] != DBNull.Value ? reader["DanhSachTacGia"].ToString() : "Unknown",
                                    Description = reader["MoTa"] != DBNull.Value ? reader["MoTa"].ToString() : "",
                                    MD5 = reader["MaMD5"] != DBNull.Value ? reader["MaMD5"].ToString() : "",
                                    CoverImagePath = reader["DuongDanAnhBia"] != DBNull.Value ? reader["DuongDanAnhBia"].ToString() : null,
                                    FilePath = reader["DuongDanFile"].ToString(),
                                    FileType = reader["DinhDang"].ToString(),
                                    TotalPages = reader["TongSoTrang"] != DBNull.Value ? Convert.ToInt32(reader["TongSoTrang"]) : 0,
                                    CurrentPage = Convert.ToInt32(reader["TrangHienTai"]),
                                    FileSizeKB = reader["KichThuocKB"] != DBNull.Value ? Convert.ToInt32(reader["KichThuocKB"]) : 0,
                                    IsFavorite = Convert.ToBoolean(reader["YeuThich"]),
                                    DateAdded = Convert.ToDateTime(reader["NgayThem"]),
                                    Rating = reader["XepHang"] != DBNull.Value ? Convert.ToByte(reader["XepHang"]) : (byte)0
                                };

                                if (book.TotalPages > 0)
                                    book.Progress = (double)book.CurrentPage / book.TotalPages * 100;

                                list.Add(book);
                            }
                        }
                    }
                }
            }
            catch { }
            return list;
        }

        public void AddBook(Book book)
        {
            using (var conn = DatabaseConnection.Instance.GetConnection())
            {
                conn.Open();
                using (var trans = conn.BeginTransaction())
                {
                    try
                    {
                        string insertSach = @"
                            INSERT INTO Sach (MaNguoiDung, TieuDe, MoTa, MaMD5, DuongDanAnhBia, DinhDang, KichThuocKB, TongSoTrang, DuongDanFile, NgayThem, YeuThich)
                            VALUES (@Uid, @Title, @Desc, @MD5, @Cover, @Fmt, @Size, @Pages, @Path, @Date, @Fav);
                            SELECT CAST(SCOPE_IDENTITY() as int);";

                        int newBookId;
                        using (var cmd = new SqlCommand(insertSach, conn, trans))
                        {
                            cmd.Parameters.AddWithValue("@Uid", currentUserId);
                            cmd.Parameters.AddWithValue("@Title", book.Title);
                            cmd.Parameters.AddWithValue("@Desc", (object)book.Description ?? DBNull.Value);
                            cmd.Parameters.AddWithValue("@MD5", (object)book.MD5 ?? DBNull.Value);
                            cmd.Parameters.AddWithValue("@Cover", (object)book.CoverImagePath ?? DBNull.Value);
                            cmd.Parameters.AddWithValue("@Fmt", book.FileType);
                            cmd.Parameters.AddWithValue("@Size", book.FileSizeKB);
                            cmd.Parameters.AddWithValue("@Pages", book.TotalPages);
                            cmd.Parameters.AddWithValue("@Path", book.FilePath);
                            cmd.Parameters.AddWithValue("@Date", DateTime.Now);
                            cmd.Parameters.AddWithValue("@Fav", book.IsFavorite);

                            newBookId = (int)cmd.ExecuteScalar();
                        }

                        if (!string.IsNullOrEmpty(book.Author))
                        {
                            var authors = book.Author.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries);
                            foreach (var authName in authors)
                            {
                                string nameTrim = authName.Trim();
                                int authorId = 0;

                                using (var cmdCheck = new SqlCommand("SELECT MaTacGia FROM TacGia WHERE TenTacGia = @Name", conn, trans))
                                {
                                    cmdCheck.Parameters.AddWithValue("@Name", nameTrim);
                                    var res = cmdCheck.ExecuteScalar();
                                    if (res != null) authorId = (int)res;
                                }

                                if (authorId == 0)
                                {
                                    using (var cmdInsAuth = new SqlCommand("INSERT INTO TacGia (TenTacGia) VALUES (@Name); SELECT CAST(SCOPE_IDENTITY() as int);", conn, trans))
                                    {
                                        cmdInsAuth.Parameters.AddWithValue("@Name", nameTrim);
                                        authorId = (int)cmdInsAuth.ExecuteScalar();
                                    }
                                }

                                using (var cmdLink = new SqlCommand("INSERT INTO Sach_TacGia (MaSach, MaTacGia) VALUES (@Bid, @Aid)", conn, trans))
                                {
                                    cmdLink.Parameters.AddWithValue("@Bid", newBookId);
                                    cmdLink.Parameters.AddWithValue("@Aid", authorId);
                                    cmdLink.ExecuteNonQuery();
                                }
                            }
                        }
                        trans.Commit();
                        book.Id = newBookId;
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw new Exception("Lỗi thêm sách: " + ex.Message);
                    }
                }
            }
        }

        public void DeleteBook(int bookId)
        {
            string query = "IF NOT EXISTS (SELECT 1 FROM ThungRac WHERE MaSach = @Id) INSERT INTO ThungRac (MaSach) VALUES (@Id)";
            ExecuteSimpleNonQuery(query, "@Id", bookId);
        }

        public void RestoreBook(int bookId)
        {
            string query = "DELETE FROM ThungRac WHERE MaSach = @Id";
            ExecuteSimpleNonQuery(query, "@Id", bookId);
        }

        public void PermanentlyDeleteBook(int bookId)
        {
            string query = "DELETE FROM Sach WHERE MaSach = @Id";
            ExecuteSimpleNonQuery(query, "@Id", bookId);
        }

        public void ToggleFavorite(int bookId)
                FROM GhiChu g
                JOIN Sach s ON g.MaSach = s.MaSach
                WHERE s.MaNguoiDung = @Uid 
                AND g.GhiChuCuaNguoiDung <> '' 
                ORDER BY g.NgayTao DESC";
            return ExecuteHighlightQuery(query, userId);
        }

        public List<Highlight> GetHighlightsForBook(int bookId)
        {
            string query = "SELECT * FROM GhiChu WHERE MaSach = @Bid";
            return ExecuteHighlightQuery(query, 0, bookId);
        }

        private List<Highlight> ExecuteHighlightQuery(string query, int userId = 0, int bookId = 0)
        {
            var list = new List<Highlight>();
            try
            {
                using (var conn = DatabaseConnection.Instance.GetConnection())
                {
                    conn.Open();
                    using (var cmd = new SqlCommand(query, conn))
                    {
                        if (userId > 0) cmd.Parameters.AddWithValue("@Uid", userId);
                        if (bookId > 0) cmd.Parameters.AddWithValue("@Bid", bookId);

                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                var hl = new Highlight
                                {
                                    Id = Convert.ToInt32(reader["MaGhiChu"]),
                                    BookId = Convert.ToInt32(reader["MaSach"]),
                                    SelectedText = reader["NoiDungTrichDan"].ToString(),
                                    Note = reader["GhiChuCuaNguoiDung"] != DBNull.Value ? reader["GhiChuCuaNguoiDung"].ToString() : "",
                                    ColorHex = reader["MauSac"].ToString(),
                                    DateCreated = Convert.ToDateTime(reader["NgayTao"]),
                                    BookTitle = ColumnExists(reader, "TieuDe") && reader["TieuDe"] != DBNull.Value ? reader["TieuDe"].ToString() : ""
                                };

                                string posData = reader["ViTriCFI"].ToString();
                                if (!string.IsNullOrEmpty(posData))
                                {
                                    var parts = posData.Split('|');
                                    if (parts.Length == 3)
                                    {
                                        if (int.TryParse(parts[0], out int ch)) hl.ChapterIndex = ch;
                                        if (int.TryParse(parts[1], out int st)) hl.StartIndex = st;
                                        if (int.TryParse(parts[2], out int len)) hl.Length = len;
                                    }
                                }
                                list.Add(hl);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error fetching highlights: " + ex.Message);
            }
            return list;
        }

        private bool ColumnExists(SqlDataReader reader, string columnName)
        {
            try
            {
                return reader.GetOrdinal(columnName) >= 0;
            }
            catch
            {
                return false;
            }
        }

        public Book GetBookById(int bookId)
        {
            var list = GetAllBooks();
            return list.FirstOrDefault(b => b.Id == bookId);
        }
    }
}